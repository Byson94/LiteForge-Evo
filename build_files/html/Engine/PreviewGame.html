<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/styles.css">
    <title>Preview Game</title>
    <script src="../../../libraries/konva/konva.min.js"></script>
    <style>
        /* General styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden; /* Prevents body from scrolling */
        }

        /* Game canvas styling */
        .gameCanvas {
            position: absolute;
            background-color: #D1D1D1;
            border: 2px solid #222;
            overflow: hidden;
            z-index: 100;
            transform-origin: top left;
            display: flex;
            align-items: center;
            justify-content: center;
            left: calc(50% - 275px); /* Centering 550px width */
            top: 10vh;
            width: 550px;
            height: 550px;
        }

        /* Console styling */
        .console {
            position: absolute;
            background-color: #222;
            color: #fff;
            border-left: 1px solid #111;
            overflow-y: auto; /* Allows vertical scrolling */
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            white-space: pre-wrap;
            box-sizing: border-box;
        }

        /* Log box styling */
        .console .log-box,
        .console .log-box-big {
            background-color: #444;
            border: 1px solid #333;
            margin: 5px 0;
            padding: 20px;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            max-height: 150px;
            padding-left: 15px;
            overflow: hidden;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .console .log-box-big {
            background-color: #555;
            padding: 50px 10px 50px 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .console .log-box-big::-webkit-scrollbar {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .gameCanvas {
                width: 100vw;
                height: calc(100vh - 50px);
                position: absolute;
                left: 0;
                top: 25vh;
            }

            .console {
                width: 100vw;
                height: 50px; /* Height for the console on smaller screens */
                bottom: 0;
                right: 0;
                font-size: 12px; /* Smaller font size */
                display: flex;
                flex-direction: column;
            }

            .console .log-box,
            .console .log-box-big {
                padding: 10px;
            }

            .console .log-box-big {
                padding: 30px 10px;
            }
        }

        iframe {
            width: 100%;
            height: 500px;
            border: none;
            margin-top: 20px;
            display: block;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Add a canvas element to your preview HTML -->
    <div class="gameCanvas"></div>
    <div class="console" id="consoleOutput" style="visibility: hidden; z-index: 8000;">
        <h3>Console</h3>
    </div>

    <script>
        let stage, layer;
    
        function initializeKonva() {
            const canvasElement = document.querySelector('.gameCanvas');
    
            // Ensure the canvasElement is found
            if (!canvasElement) {
                console.error('Canvas element with class "gameCanvas" not found.');
                return;
            }
    
            // Assign an ID to the canvas element if it doesn't already have one
            if (!canvasElement.id) {
                canvasElement.id = 'gameCanvas';
            }
    
            // Create Konva stage
            stage = new Konva.Stage({
                container: 'gameCanvas', // Use ID for container
                width: canvasElement.offsetWidth,
                height: canvasElement.offsetHeight,
            });
    
            // Create Konva layer
            layer = new Konva.Layer();
            stage.add(layer);
        }
    
        function loadGameData() {
            // Retrieve data from local storage
            const gameDataJSON = localStorage.getItem('gameData');
            if (!gameDataJSON) {
                console.error('No game data found in local storage.');
                return;
            }

            try {
                // Parse the JSON data
                const gameData = JSON.parse(gameDataJSON);
                const sprites = gameData.spriteData;
                const JSCode = gameData.JsCode;
                const BlocklyCode = gameData.blocklyCode;

                // Initialize Konva
                initializeKonva();

                // Add sprites to the Konva canvas
                sprites.forEach(sprite => {
                    if (sprite.src) { // Only process if the source URL is available
                        const img = new Image();
                        img.src = sprite.src;

                        img.onload = () => {
                            const konvaImage = new Konva.Image({
                                image: img,
                                id: sprite.id,
                                x: sprite.left,
                                y: sprite.top,
                                width: sprite.width,
                                height: sprite.height,
                                offsetX: sprite.width / 2,
                                offsetY: sprite.height / 2,
                                draggable: false // Make undraggable
                            });

                            // Add Konva image to the layer and draw it
                            layer.add(konvaImage);
                            layer.draw();
                        };
                    }
                });

                // Check if JSCode is a string and contains code
                if (typeof JSCode === 'string' && JSCode.trim()) {
                    eval(JSCode);
                } else {
                    console.warn('Invalid or empty JSCode. (Dont worry if you didnt add any code here)');
                }

                // Check if BlocklyCode is a string and contains code
                if (typeof BlocklyCode === 'string' && BlocklyCode.trim()) {
                    eval(BlocklyCode);
                } else {
                    console.warn('Invalid or empty BlocklyCode. (Dont worry if you didnt add any code here)');
                }

            } catch (e) {
                console.error('Error loading game data:', e);
            }
        }
    
        // Load game data when the document is ready
        document.addEventListener('DOMContentLoaded', loadGameData);
    
        // Function to resize canvas and manage console visibility
        function resizeElements() {
            const consoleElement = document.getElementById('consoleOutput');
            const canvasElement = document.querySelector('.gameCanvas');
    
            let newWidth, newHeight;
            if (window.innerWidth <= 600) {
                newWidth = window.innerWidth;
                newHeight = window.innerHeight - 50; // Height minus console height
                consoleElement.style.display = 'flex';
            } else {
                newWidth = 550;
                newHeight = 550;
                consoleElement.style.display = 'flex';
            }
    
            // Apply the new dimensions to the canvas
            canvasElement.style.width = `${newWidth}px`;
            canvasElement.style.height = `${newHeight}px`;
    
            // Scale canvas content
            scaleCanvasContent(newWidth, newHeight);
        }
    
        // Function to scale canvas content based on new canvas size
        function scaleCanvasContent(newWidth, newHeight) {
            const scaleX = newWidth / 550; // Original canvas width
            const scaleY = newHeight / 550; // Original canvas height
            const scale = Math.min(scaleX, scaleY); // Keep aspect ratio

            // Apply the scale to the Konva stage
            stage.width(550 * scale);  // Original width * scale
            stage.height(550 * scale); // Original height * scale
            stage.scale({ x: scale, y: scale });  // Scale the stage and all its content

            stage.batchDraw(); // Redraw the stage to apply the scaling
        }
    </script>    
</body>
</html>
